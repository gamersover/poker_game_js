<h1>联机测试</h1>

<div>
    <button id="create_room" onclick="create_room()">创建房间</button>

    <input id="inputed_room_number" placeholder="输入6位数字"></input>
    <button id="join_room" onclick="join_room()">加入房间</button>
</div>



<button id="prepare" onclick="prepare()">准备</button>

<div>
    房间号：<span id="room_number"></span>
</div>

<div id="curr_user">
    名称：<span></span> &nbsp;&nbsp; 状态：<span></span>
    <br />
    手牌：<span></span>
</div>

<div id="next_user">
    名称：<span></span> &nbsp;&nbsp; 状态：<span></span>
    <br />
    手牌：<span></span>
</div>

<div id="nnext_user">
    名称：<span></span> &nbsp;&nbsp; 状态：<span></span>
    <br />
    手牌：<span></span>
</div>

<div id="nnnext_user">
    名称：<span></span> &nbsp;&nbsp; 状态：<span></span>
    <br />
    手牌：<span></span>
</div>


<div>
    游戏开局：<span id="game_init"></span>
    当前出牌用户：<span id="curr_player"></span>
</div>

<div>
    牌堆：<span id="last_raw_cards"></span>
</div>


<div id="game">
    <input id="out_cards" placeholder="请出牌" size="50"></input>
    <br/>
    <button id="game_step" , onclick="game_step()">出牌</button>
    <button id="pass" onclick="game_pass()">跳过</button>
</div>

游戏信息：<p id="game_msg"></p>

<script src="./card.js"></script>
<script src="http://localhost:3000/socket.io/socket.io.js"></script>
<script>
    var user_id_to_div_id = {
        0: "curr_user",
        1: "next_user",
        2: "nnext_user",
        3: "nnnext_user"
    }

    var user_data = {
        room_number: null,
        user_name: "ABC",
        game_state: {}
    }
    var socket = null

    function update_room_state(data, user_data) {
        for (let player_id in data.players_info) {
            diff = player_id - user_data.user_id
            // 即python中的%运算，a % b = a - (a // b) * b
            div_id = diff - Math.floor(diff / 4) * 4
            div_id = user_id_to_div_id[div_id]
            div = document.getElementById(div_id)
            items = div.getElementsByTagName("span")
            items[0].innerText = data.players_info[player_id].player_name
            if (data.players_info[player_id].state == 0) {
                items[1].innerText = "加入房间"
            }
            else if (data.players_info[player_id].state == 1) {
                items[1].innerText = "已准备"
            }

            document.getElementById("room_number").innerText = data.room_number
        }
    }

    function create_room() {
        if (user_data.room_number) {
            document.getElementById("game_msg").innerText = `你已在${user_data.room_number}房间，无法创建其他房间`
            // console.log(`你已在${user_data.room_number}房间，无法创建其他房间`)
        }
        else {
            socket = io('ws://localhost:3000', {
                // 显式指定websocket传输层
                transports: ['websocket']
            });

            socket.emit("create_room", {
                room_number: user_data.room_numebr,
                user_name: user_data.user_name
            })

            socket.on("create_room", (data) => {
                console.log(data.msg)
                if (data.status == 1) {
                    user_data.room_number = data.room_number
                    user_data.user_name = data.player_name
                    user_data.user_id = data.player_id
                    update_room_state(data, user_data)
                }
            })

            socket.on("prepare_start", (data) => {
                console.log(data.msg)
                if (data.status == 1) {
                    update_room_state(data, user_data)
                }
            })

            socket.on("join_room_others", (data) => {
                console.log(data.msg)
                if (data.status === 1) {
                    update_room_state(data, user_data)
                }
            })
        }
    }

    function join_room() {
        user_data.inputed_room_number = document.getElementById("inputed_room_number").value
        if (user_data.room_number) {
            console.log(`你已在${user_data.room_number}房间，无法加入其他房间`)
        }
        else if (/^[0-9]{6}$/.exec(user_data.inputed_room_number)) {
            socket = io('ws://localhost:3000', {
                // 显式指定websocket传输层
                transports: ['websocket']
            });

            socket.emit("join_room", {
                room_number: user_data.inputed_room_number,
                user_name: user_data.user_name
            })

            socket.on("join_room", (data) => {
                console.log(data.msg)
                if (data.status == 1) {
                    user_data.room_number = data.room_number
                    user_data.user_name = data.player_name
                    user_data.user_id = data.player_id
                    update_room_state(data, user_data)
                }
            })

            socket.on("prepare_start", (data) => {
                console.log(data.msg)
                if (data.status == 1) {
                    update_room_state(data, user_data)
                }
            })

            socket.on("join_room_others", (data) => {
                console.log(data.msg)
                if (data.status === 1) {
                    update_room_state(data, user_data)
                }
            })
        }
        else {
            console.log("房间号必须为6位数字")
        }
    }

    function prepare() {
        socket.emit("prepare_start", {
            room_number: user_data.room_number,
            user_name: user_data.user_name,
            user_id: user_data.user_id
        })

        socket.on("game_start", (data) => {
            cards_item = document.getElementById("curr_user").getElementsByTagName("span")[2]
            cards_item.innerText = data.all_cards.join(" ")
            document.getElementById("game_init").innerText = `朋友牌：${data.friend_card}，首位出牌用户：${data.first_player_name}`
            document.getElementById("curr_player").innerText = data.first_player_name

            user_data.all_cards = data.all_cards
            user_data.curr_player_id = data.curr_player_id
            user_data.curr_player_name = data.curr_player_name

            // if (data.curr_player_name === user_data.user_name) {
            //     document.getElementById("game_msg").innerText = "请出牌"
            // }
        })

        socket.on("game_step", (data) => {
            document.getElementById("game_msg").innerText = "请出牌"
            alert("请出牌")
            user_data.game_state.last_valid_cards_info = data.last_valid_cards_info
            user_data.game_state.is_start = data.is_start
        })

        socket.on("game_step_info", (data) => {
            user_data.curr_player_id = data.curr_player_id
            user_data.curr_player_name = data.curr_player_name
            if (data.status === 1) {
                document.getElementById("last_raw_cards").innerText = data.last_valid_cards.toString()
            }
            document.getElementById("curr_player").innerText = data.curr_player_name
        })
    }

    function game_step() {
        if (user_data.curr_player_name === user_data.user_name) {
            var raw_out_cards = document.getElementById("out_cards").value
            var result = is_valid_out_cards(raw_out_cards, false, user_data.game_state, user_data.all_cards)
            console.log(result)
            if (result.status === -1) {
                document.getElementById("game_msg").innerText = "无法跳过，请出牌"
                alert("无法跳过，请出牌")
            }
            else if (result.status === 0) {
                document.getElementById("game_msg").innerText = "非法出牌"
                alert("非法出牌")
            }
            else if (result.status === 1) {
                // 移除已出手牌 user_data.all_cards
                for (let card of result.raw_cards) {
                    user_data.all_cards.splice(user_data.all_cards.indexOf(card), 1)
                }
                cards_item = document.getElementById("curr_user").getElementsByTagName("span")[2]
                cards_item.innerText = user_data.all_cards.join(" ")
                // TODO: 出牌成功后清空input out_cards
                socket.emit("game_step", {
                    room_number: user_data.room_number,
                    raw_out_cards: raw_out_cards,
                    cards_info: result.cards_info,
                    all_cards: user_data.all_cards,
                    out_state: OutState.VALID,
                    curr_player_id: user_data.curr_player_id
                })
            }
            else if (result.status == 2) {
                socket.emit("game_step", {
                    out_state: OutState.PASS
                })
            }
            else if (result.status == 3) {
                socket.emit("game_step", {
                    out_state: OutState.NO_CARDS
                })
            }
        }
        else {
            document.getElementById("game_msg").innerText = "非出牌时间"
        }
    }

    function game_pass() {
        if (user_data.curr_player_name === user_data.user_name) {
            var result = is_valid_out_cards(null, true, user_data.game_state, user_data.all_cards)
            if (result.status === 2) {
                socket.emit("game_step", {
                    room_number: user_data.room_number,
                    curr_player_id: user_data.curr_player_id
                })
            }
            else if(result.status === -1){
                document.getElementById("game_msg").innerText = "无法跳过，请选择出牌"
            }
        }
        else {
            document.getElementById("game_msg").innerText = "非出牌时间"
        }
    }
</script>